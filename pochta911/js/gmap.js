jQuery(function ($) {
    if ($('#map').length) {
        initMap();
    }
    google_autocomlete()
});

var map, directionsService, directionsDisplay;
var poly_spb_kad, poly_VO, poly_Petro, poly_Left, poly_Right, poly_vsevol;
var order_route = [];
var poly_vars = [];
var polys = [];

// Санкт-Петербург
var poly_spb_kad_var = [[30.546681473461607,59.971508573316704],[30.54393489143016,59.9732295202758],[30.540501663891433,59.97495037750411],[30.536725113598305,59.976326998682275],[30.532605240551412,59.97804769440251],[30.526082108227165,59.97942418637845],[30.517842362133656,59.98131676908907],[30.51303584357857,59.98148881667979],[30.507199356762083,59.98269312469402],[30.50376612922346,59.986305784983024],[30.50582606574626,59.98888601440774],[30.50582606574626,59.99352991876726],[30.50548274299267,59.99817316926073],[30.50273616096122,60.00264382958245],[30.50204951545341,60.006254304976395],[30.500332901684377,60.00952058482362],[30.493809769359903,60.012098998163715],[30.489003250805247,60.01072386948774],[30.483510086742832,60.0136459493346],[30.480076859203727,60.01639590543855],[30.474583695141312,60.0188019287605],[30.47115046760205,60.02155145454778],[30.46806056281681,60.02447257425089],[30.46634394904732,60.02825246226994],[30.46565730353979,60.03220369954826],[30.45947749396923,60.03615446272432],[30.453984329906767,60.038730791999065],[30.44608790656705,60.04044823283525],[30.442311356273795,60.040619971990765],[30.43784816047293,60.040276492775234],[30.437161514965528,60.04353940052452],[30.43235499641072,60.04577172998087],[30.427548477856014,60.04731710013351],[30.42239863654744,60.04886239771495],[30.418278763500474,60.04972086501382],[30.41381556769961,60.05075099620876],[30.40969569465297,60.051266049711074],[30.40523249885231,60.05298283648879],[30.40111262580524,60.054699533683205],[30.393559525219338,60.057102759250725],[30.38772303840311,60.059677448969225],[30.386693070141252,60.062766810604636],[30.383259842602193,60.067400308951754],[30.382573197094434,60.07169000307594],[30.381886551586827,60.077179994872196],[30.379826615062985,60.08284058860618],[30.37708003303174,60.08661377610685],[30.372960159985304,60.089357640323264],[30.368153641430013,60.09107243908637],[30.364377091137342,60.09038653032316],[30.36128718635233,60.086956771666635],[30.341031143871653,60.085413263448025],[30.32935817023868,60.08438421768328],[30.319058487621536,60.0814684129917],[30.31150538703584,60.07906696778669],[30.305325577465208,60.075464470933774],[30.303265640941724,60.07066052753104],[30.304638931957346,60.06791510179952],[30.30257899543432,60.06602748861901],[30.296055863109842,60.06534105695827],[30.289532730785545,60.062938433297795],[30.28300959846125,60.061050534412324],[30.276829788891177,60.05950580925792],[30.27099330207469,60.05950580925792],[30.265500138012325,60.05881924145652],[30.25554377814887,60.05933416865117],[30.24970729133264,60.05950580925792],[30.244900772777935,60.05916252714855],[30.241810867992797,60.057102759250725],[30.236661026684224,60.05572950899124],[30.23151118537575,60.05349785504424],[30.22739131232853,60.05160941422461],[30.23048121711407,60.04886239770589],[30.236317703930432,60.04456972523428],[30.230824539867736,60.04079171023197],[30.223958084789647,60.03787203795939],[30.217778275219576,60.03563917265519],[30.213658402172197,60.033577931797694],[30.20919520637164,60.031688347642124],[30.208851883618053,60.02773704852205],[30.212285111156728,60.025675312933124],[30.217778275219576,60.02361344827094],[30.222928116527868,60.0208640945975],[30.22739131232853,60.0181145114373],[30.230824539867736,60.014677209751426],[30.221211502758198,60.01347406942126],[30.207135269847825,60.01141144096213],[30.201985428539786,60.00934868339189],[30.1961489417231,60.00436315286398],[30.19305903693806,60.000924416551584],[30.1885958411374,59.996625491708116],[30.1885958411374,59.990778054341575],[30.188252518383177,59.98716588384833],[30.192029068676227,59.98080062089818],[30.20129878303218,59.97477829578289],[30.207135269847825,59.97013175110424],[30.20473201057088,59.962041760920386],[30.190312454906813,59.95584383181361],[30.18550593635221,59.95412197839318],[30.180699417797126,59.9487836623119],[30.17898280402771,59.941894237696474],[30.181386063305087,59.9360370972396],[30.19408900519966,59.9251814165957],[30.192029068676227,59.913460173416986],[30.18516261359814,59.900182573809836],[30.17005641242614,59.891557902742996],[30.164563248363645,59.88569184294622],[30.155980179515993,59.8834486631177],[30.14842707893009,59.877581166817656],[30.14156062385195,59.87481963246919],[30.130955772082594,59.86942514059081],[30.128638343493588,59.868130381378315],[30.127265052477966,59.86614498567661],[30.125290946643055,59.86485009832022],[30.12983997313224,59.86295083866544],[30.133874015490836,59.86269184028515],[30.138337211291294,59.8618284977364],[30.139796332995797,59.85975638388432],[30.139796332995797,59.856907015866945],[30.138337211291294,59.85423011375826],[30.135333137194678,59.85233024567732],[30.133273200671372,59.8505598160926],[30.13258655516343,59.84926431993376],[30.130698280017125,59.847320980817884],[30.130354957263002,59.846327674634104],[30.130440787951578,59.845463905948904],[30.131041602771017,59.843909065637135],[30.130869941394018,59.842354152451236],[30.13018329588621,59.83997844990871],[30.129754142443918,59.83915771313757],[30.129582481066997,59.83833695606521],[30.128209190051145,59.837084182445636],[30.12760837523201,59.83565855493357],[30.12735088316654,59.83501052218191],[30.130440787951578,59.830041850676935],[30.13378818480216,59.82801096211148],[30.13627727476778,59.82593673490538],[30.140482978503176,59.82502921974014],[30.1431437298461,59.8245106285131],[30.147864417712256,59.824553844758285],[30.158164100329376,59.82351663935338],[30.164172248523062,59.82317089701813],[30.173184470812906,59.822760323309396],[30.166232185046088,59.81915137815764],[30.16434390989978,59.81552042677777],[30.165030555407668,59.81149998182261],[30.174729423205704,59.807435811745194],[30.18193920103781,59.8082573330235],[30.187861518542235,59.80990031463894],[30.193526343981674,59.81080824330426],[30.201251105944774,59.81240786675892],[30.20622928587645,59.813964183223185],[30.21249492613505,59.81724950074473],[30.21541316954324,59.81889203764325],[30.217215614001358,59.82023194178684],[30.220820502917235,59.821744671810556],[30.2276869579955,59.824121679759244],[30.231377677599873,59.825158866263045],[30.237900809924145,59.826325662342285],[30.244080619494653,59.8279245385296],[30.249573783556762,59.82935049826995],[30.25480945555429,59.8307331886126],[30.259100989977927,59.83172696172151],[30.263993339220903,59.83263429379264],[30.26708324400594,59.83375762294409],[30.272233085314895,59.83418966249485],[30.27824123350789,59.833714418680074],[30.28261859862036,59.83293673230429],[30.286309318224887,59.83142451218617],[30.288540916125523,59.82891839572633],[30.29274661986038,59.825936734860484],[30.295321540515037,59.82425132982605],[30.298153953234575,59.822868369485306],[30.30141551939684,59.821096367363786],[30.30562122313218,59.81928104762373],[30.31034191099864,59.8172062749742],[30.315062598864287,59.81465585600551],[30.31858165709248,59.812883415619616],[30.322787360827387,59.811154114336844],[30.331284598986645,59.80955443048876],[30.335576133410665,59.80946795889763],[30.34098346678425,59.81037589937948],[30.34596164671618,59.81201877622238],[30.35119731871328,59.81361834139504],[30.355832175890733,59.81452616844369],[30.360896186511187,59.814612626868474],[30.36613185850808,59.81456939767468],[30.37145336119355,59.814699085058706],[30.37917812315665,59.81521782953158],[30.38544376341522,59.81590947622556],[30.393683509508932,59.81664433505635],[30.40260990111071,59.81772498027065],[30.412995414416123,59.81975649808205],[30.42372425047579,59.82226330620441],[30.43144901243866,59.82407846290677],[30.435826377551024,59.82576387671618],[30.43865879027087,59.8268010119195],[30.44183452574494,59.829307288232805],[30.44681270567606,59.832547882247134],[30.452477531115672,59.837040982440115],[30.455910758654934,59.84105833571249],[30.459086494128037,59.84481606458544],[30.462433890978975,59.84792558732005],[30.473935203234774,59.84749372658404],[30.472476081530626,59.84412501993962],[30.47925670592024,59.84028082140672],[30.488354758898762,59.837127382233255],[30.490929679552778,59.83609056965715],[30.492217139880083,59.83544254534125],[30.493762092272704,59.834880914032134],[30.497195319811684,59.83323916800652],[30.498396949450385,59.832720705023526],[30.500886039416617,59.831510926566175],[30.505435065905672,59.82973938568725],[30.508954124133002,59.82857270957839],[30.513159827868648,59.82697386460937],[30.5154772564573,59.82658494473023],[30.517794685046255,59.8276652664786],[30.520541267077345,59.82952333764986],[30.522343711535385,59.83043072995888],[30.52320201841999,59.83246147048569],[30.523631171862384,59.833887235337095],[30.518481330553836,59.83561535304519],[30.517966346423123,59.83647937815491],[30.515906409899614,59.83816416241698],[30.513932304064678,59.83954648561885],[30.51101406065664,59.84127430864284],[30.507495002428954,59.84252692407387],[30.501143531481606,59.84343396089873],[30.496594504992473,59.8434771525099],[30.49213130919161,59.845938981401275],[30.49110134093021,59.85030072117833],[30.490071372668556,59.85189844256751],[30.491702155749906,59.85280522317112],[30.493504600207817,59.853452908422895],[30.496937827746873,59.8536688006957],[30.501658515612824,59.85410058101612],[30.504490928332594,59.85457553288538],[30.508353309313918,59.85556859208548],[30.511185722034043,59.857166059702465],[30.51504810301501,59.858504419265635],[30.518824653308236,59.8606629498911],[30.522772864978414,59.86251917383481],[30.527064399402153,59.86489326228088],[30.530497626941234,59.86787142369997],[30.531441764514312,59.87046091177708],[30.532128410022835,59.872575510686495],[30.53195674864561,59.873870096243536],[30.530669288318663,59.87555298185649],[30.529132520418347,59.87883336981325],[30.527759229402726,59.88150828562269],[30.52630010769863,59.88422612399857],[30.526042615633312,59.88513202056898],[30.525270139437,59.88664179312733],[30.52466932461769,59.888108363425914],[30.52432600186367,59.88974739455328],[30.524240171175247,59.89155886089447],[30.524411832552193,59.89268019516048],[30.52458349392919,59.89427587460641],[30.525110617303284,59.89712709727119],[30.52553977074588,59.898808801573956],[30.525968924188096,59.90027483305678],[30.526655569695905,59.90204260819671],[30.526312246941934,59.903292928728284],[30.526312246941934,59.90488809669482],[30.526312246941934,59.9061814196854],[30.526226416253614,59.9074315838661],[30.526398077630613,59.90881102056616],[30.525797262811096,59.910966275291],[30.525797262811096,59.912431768316516],[30.525883093499672,59.91471608386954],[30.525883093499672,59.91643999116994],[30.526655569696235,59.91984444445955],[30.527513876580993,59.92156808450895],[30.52897299828509,59.923679421153736],[30.530775442743103,59.92548903099634],[30.53352202477435,59.92755703527551],[30.536182776117123,59.93044340832541],[30.538242712640557,59.93419100925095],[30.538671866082947,59.93737828947385],[30.538843527459896,59.9397470148727],[30.539616003656178,59.942417010864965],[30.540817633294857,59.9452590276239],[30.542276754998976,59.948445240592534],[30.544851675653252,59.95102843094832],[30.548347978706047,59.953787358264634],[30.550150423164062,59.95581054730159],[30.551437883491214,59.957661441480134],[30.55358365070312,59.959942633447845],[30.553669481391594,59.962438851628406],[30.553411989326175,59.964633646183024],[30.55263951312989,59.966742232938],[30.551952867622028,59.96824828386471],[30.550922899360323,59.96945307515107],[30.549120454902308,59.97108807870775],[30.546681473461607,59.971508573316704]];

// Всеволожск
var poly_vsevolozhsk_var = [[30.588656760948506,59.999484236345545],[30.5915750043567,60.00146163993345],[30.595351554649675,60.0038687537899],[30.59792647530397,60.00490032020885],[30.603076316612544,60.00644760930842],[30.610629417198496,60.00808078011618],[30.61492095162231,60.00962791991797],[30.621272422569586,60.01048741064755],[30.62985549141724,60.01237821135026],[30.63706526924927,60.01289386544063],[30.641356803673112,60.013925149413836],[30.650798179405523,60.014182965363936],[30.659037925499288,60.014956401110844],[30.666762687462157,60.01547201485601],[30.672770835655513,60.016331353167345],[30.68049559761841,60.01796403421163],[30.683413841026628,60.01994032933066],[30.68736205269655,60.0218305876393],[30.692511894005122,60.02389256390726],[30.695601798790285,60.023978476783874],[30.702296592491454,60.023978476783874],[30.709163047569593,60.022260176673186],[30.71431288887819,60.01916701057735],[30.71362624337038,60.01177660471277],[30.725470878380147,60.0102295657823],[30.725985862510985,60.005845894400544],[30.724097587364497,59.99982814114141],[30.721522666710225,59.996388931750836],[30.71105132271608,59.994841170483255],[30.702468253868425,59.99329333656578],[30.685645438927008,59.993551313930546],[30.682212211387952,59.988563393878074],[30.672770835655513,59.98409082418235],[30.661441184776614,59.98185431192047],[30.64393172432741,59.98004778748472],[30.633288718956297,59.980133814700785],[30.62213072945434,59.98366073744524],[30.617839195030527,59.988821408243396],[30.61698088814577,59.993121350534715],[30.607539512413332,59.99690483602934],[30.600501395958272,59.99767867731238],[30.59432158638794,59.998108581288726],[30.590030051964128,59.99853847965977],[30.588656760948506,59.999484236345545]];

var poly_VO_var = [[30.259932,59.919203],[30.19573,59.933852],[30.177363,59.944791],[30.209978,59.962715],[30.230921,59.963404],[30.261648,59.956517],[30.282705,59.949543],[30.292834,59.94696],[30.312746,59.945152],[30.309313,59.941707],[30.277413,59.932008]];
var poly_Petro_var = [[30.318068,59.947178],[30.294893,59.947006],[30.224009,59.967573],[30.208732,59.968004],[30.211135,59.978406],[30.250274,59.982277],[30.275336,59.980909],[30.292674,59.982888],[30.320826,59.978672],[30.329974,59.973584],[30.335468,59.965494],[30.337528,59.956628],[30.340617,59.95358]];
var poly_Left_var = [[30.260967,59.91671],[30.268863,59.921537],[30.274528,59.929551],[30.288947,59.934117],[30.30474,59.938941],[30.334781,59.950136],[30.358814,59.951428],[30.36658,59.951686],[30.380313,59.955474],[30.390441,59.957971],[30.402343,59.952117],[30.395476,59.926276],[30.413624,59.910701],[30.438344,59.900009],[30.451218,59.87827],[30.459801,59.871366],[30.477654,59.868173],[30.4907,59.861353],[30.491902,59.852804],[30.467698,59.848832],[30.457055,59.840626],[30.435597,59.823602],[30.411221,59.818934],[30.386502,59.814785],[30.355603,59.814093],[30.341183,59.80951],[30.326077,59.8083],[30.308739,59.81271],[30.281617,59.828961],[30.265481,59.832072],[30.2375,59.825417],[30.207459,59.813228],[30.169522,59.799565],[30.156991,59.795932],[30.139138,59.800516],[29.999564,59.846184],[30.094321,59.884858],[30.211051,59.91935]];
var poly_Right_var = [[30.281879047363063,60.0728481255657],[30.270206073730346,60.07044605043734],[30.26196632763656,60.066671006322515],[30.255786518066156,60.0642684798369],[30.248233417480332,60.062552282014664],[30.24068031689433,60.060149454592135],[30.233813861816166,60.05740315113875],[30.222827533691284,60.05534327306243],[30.21596107861299,60.052596568301425],[30.213214496581877,60.04710247075675],[30.194675067870893,60.037829100706],[30.197421649902136,60.03301965789237],[30.214587787597498,60.026835056119495],[30.220767597167775,60.02271134292798],[30.226260761230293,60.0189308189262],[30.233127216308432,60.01480611607249],[30.22900734326156,60.00930570895688],[30.218707660644416,60.009993310056274],[30.209781269042896,60.012056027278746],[30.200168231933358,60.0103371052262],[30.193988422363105,60.00655516109342],[30.185748676269395,60.000365589073155],[30.185748676269395,59.99623856203188],[30.185748676269395,59.99073505569224],[30.185062030761582,59.986950862279144],[30.185748676269395,59.9831662346899],[30.192615131347484,59.980757609241266],[30.20222816845692,59.98041350553677],[30.210467914550605,59.98006939824364],[30.219394306152125,59.980757609241266],[30.22832069775375,59.981445805883915],[30.238620380370897,59.98247807393329],[30.250979999511475,59.98110170935681],[30.264026264159867,59.981445805883915],[30.277072528808358,59.981445805883915],[30.288058856933393,59.98213398817209],[30.29835853955046,59.98247807393329],[30.30728493115221,59.98213398817209],[30.316211322753787,59.98041350553677],[30.328570941894313,59.977316410702144],[30.33406410595696,59.972498129800044],[30.339557270019373,59.96664641434664],[30.340930561034995,59.95907206610229],[30.345050434081916,59.95562860610762],[30.354663471191248,59.953906741466405],[30.364963153808393,59.953906741466405],[30.37594948193348,59.95528424036046],[30.380069354980193,59.9587277362596],[30.388995746581717,59.96148227447542],[30.3999820747069,59.95976071501725],[30.40959511181621,59.95528424036046],[30.4075351752928,59.94908504289416],[30.40616188427718,59.939439534179904],[30.40272865673812,59.934271139071555],[30.40272865673812,59.9291019357393],[30.40547523876929,59.924621305688326],[30.411655048339643,59.91772684303803],[30.424014667480222,59.9097964340799],[30.44049415966785,59.90358870093413],[30.447360614745936,59.8959998900006],[30.45216713330054,59.88771920276109],[30.454913715331838,59.878400954081926],[30.4617801704099,59.87356823750193],[30.471393207519235,59.87080636867777],[30.481692890136557,59.86977060852293],[30.492679218261515,59.86493663309868],[30.49817238232418,59.86079266443307],[30.49774008523022,59.85249838923875],[30.505979831324083,59.85353468915789],[30.51215964089436,59.857679565018564],[30.52108603249591,59.86320526028426],[30.53138571511323,59.8687300346363],[30.532072360620866,59.87390867430726],[30.52863913308181,59.87977682101459],[30.525892551050564,59.885989020052364],[30.522459323511534,59.89116496265426],[30.522459323511534,59.89634009632037],[30.52383261452713,59.903239016344614],[30.52383261452713,59.91013649861484],[30.5252059055428,59.91668777523619],[30.525892551050564,59.922893051220186],[30.53001242409761,59.92702925513731],[30.53275900612868,59.934266367169144],[30.535505588159975,59.93977929401225],[30.536192233667837,59.945291301379775],[30.539625461206942,59.95183561603033],[30.546491916285007,59.955968199486016],[30.54992514382391,59.96010026590764],[30.549238498316278,59.968018614860945],[30.544431979761548,59.972837549708935],[30.532072360620866,59.97696750536367],[30.518339450464662,59.98040874028788],[30.505979831324083,59.98281739120492],[30.494306857691317,59.98660205907405],[30.487440402613178,59.98866624022059],[30.481947238550685,59.993138189581146],[30.477140719996008,59.99898520848629],[30.477140719996008,60.00345575869864],[30.475080783472546,60.00861333259734],[30.473707492456924,60.01342634014776],[30.464094455347563,60.01583258032713],[30.456541354761615,60.020988217587494],[30.451734836206935,60.02579941779425],[30.447614963160067,60.03026633161035],[30.44280844460536,60.03507617661152],[30.439375217066303,60.039885319015546],[30.434568698511626,60.045724047471985],[30.420835788355372,60.049844879248376],[30.3954299045663,60.056368474211865],[30.388563449488185,60.06083124125891],[30.38513022194913,60.06700945758782],[30.383756930933504,60.07215708456545],[30.37963705788661,60.077646998356784],[30.37963705788661,60.08382205542918],[30.375517184839744,60.08931002099287],[30.36521750222255,60.09342539360818],[30.36178427468349,60.08588014994215],[30.359037692652244,60.08142078222491],[30.33912497292569,60.086909148855845],[30.316465671167865,60.08416508013387],[30.30341940651942,60.07970547964198],[30.300672824488178,60.07284337393434],[30.281879047363063,60.0728481255657]];

var poly_var = [[30.59123028299004,59.8102578682166],[30.58848370095892,59.80766367750143],[30.582647214142106,59.80610706583567],[30.574750790802515,59.8038584980096],[30.569257626739923,59.800571855920296],[30.565481076447202,59.79711188148346],[30.56067455789232,59.79538175918632],[30.555181393829855,59.79572779085035],[30.543508420196883,59.80212872690363],[30.531148801056048,59.803512550991876],[30.52325237771646,59.801609778013095],[30.518102536407582,59.80299362371174],[30.5122660495914,59.807490724251316],[30.502996335235984,59.805934104482176],[30.498876462189013,59.80264766768939],[30.496129880157973,59.79797690886189],[30.492696652618637,59.793997596507914],[30.486516843048562,59.79347852064424],[30.465917477814475,59.78794120707327],[30.458021054474454,59.77842179438259],[30.442571530548634,59.78084517614369],[30.43673504373215,59.78049898956],[30.428495297638438,59.778941105338326],[30.41613567849778,59.77634446947069],[30.40446270486481,59.77530575837063],[30.391073117462426,59.77340137044845],[30.376996884552074,59.77305510638687],[30.36292065164188,59.77305510638687],[30.345067868438935,59.77651758483441],[30.33236492654477,59.779633507325045],[30.324125180450853,59.7772100372794],[30.30009258767743,59.77946040817755],[30.290502978488743,59.782861728783],[30.27711339108656,59.7847655751454],[30.268186999484833,59.78597705699119],[30.252737475559012,59.78580399085843],[30.231451464816455,59.78199630802319],[30.23351140134014,59.77455275996556],[30.226644946262205,59.77437963437702],[30.221151782199307,59.775418374394576],[30.19196934811731,59.767627033648424],[30.14699406735611,59.75498386649246],[30.12055821530503,59.75377125565357],[30.11128850094959,59.75533031862048],[30.094122363254357,59.76139264729209],[30.079702807590216,59.76450998644849],[30.070089770480475,59.77057064347195],[30.05292363278524,59.762778167407824],[30.035414172336115,59.76364408819221],[30.023585366409993,59.76838688968982],[30.032500644706325,59.77152847142944],[30.037650486015355,59.77516423116711],[30.041083713554464,59.77931889865029],[30.041427036308406,59.78381920286533],[30.034217258475838,59.78849195119879],[30.047263523124613,59.80371709227838],[30.05412997820298,59.81288341498452],[30.062369724296488,59.81755207878188],[30.064086338066538,59.82204720889248],[30.066146274589844,59.82567744671157],[30.06168307878898,59.83483771063116],[30.059623142265675,59.843131617464906],[30.048980136894407,59.84624129808865],[30.03936709978497,59.8486597370544],[30.042113681816218,59.85297793951697],[30.047606845878224,59.8581590403752],[30.04829787494756,59.86081352243898],[30.0565376210413,59.861504219422486],[30.074047081490527,59.86081352243898],[30.090526573678027,59.86167689141998],[30.10425948383428,59.862712904518354],[30.11455916645145,59.862712904518354],[30.12176894428348,59.86133154652566],[30.131725304146787,59.859777449982474],[30.13041523280408,59.85094580962742],[30.1256087142494,59.84610908873996],[30.1256087142494,59.84161721636873],[30.123548777725965,59.837124735784045],[30.123548777725965,59.83366856758022],[30.123548777725965,59.82779225554026],[30.119428904679097,59.822606410355135],[30.119428904679097,59.81499903874389],[30.131101878311892,59.81050295452709],[30.13796833339003,59.80600626171291],[30.14689472499158,59.800125052719835],[30.1585676986244,59.79597298435013],[30.171957286026732,59.79943307733631],[30.176763804581437,59.80150896023703],[30.179167063858763,59.80306578731916],[30.181913645889985,59.80687105758997],[30.19015339198377,59.80920589404665],[30.198393138077535,59.80981119524682],[30.20525959315565,59.81292399857251],[30.215902598526736,59.8175926566573],[30.22311237635877,59.82156914411316],[30.23615864100721,59.82433511541977],[30.24954822840952,59.828137949734476],[30.259504588272847,59.8298663668065],[30.267744334366586,59.83211317444362],[30.27735737147592,59.831940348490534],[30.282507212784466,59.8310762051951],[30.287657054093142,59.827792255531264],[30.296926768448607,59.82105049883201],[30.309629710343156,59.81534486616037],[30.315466197159513,59.81223228969422],[30.31889942469857,59.81033001604848],[30.321302683975947,59.80842763347149],[30.32988575282358,59.808946475876155],[30.336752207901693,59.80808173400649],[30.342588694718152,59.81084882875642],[30.354261668350972,59.81361569302432],[30.36387470546033,59.81292399857251],[30.371771128800173,59.81326984759445],[30.381040843155642,59.81188642987378],[30.38790729823378,59.81499903874389],[30.40370014491347,59.81707394927607],[30.418463023331423,59.82001318398493],[30.4387190658119,59.825026572235316],[30.445585520890013,59.82986636680645],[30.451078684952527,59.8347054558167],[30.4576018172767,59.841271662515204],[30.460005076554076,59.84403599244061],[30.47373798671033,59.840234979424054],[30.49124744715956,59.83228599949672],[30.501547129776704,59.82813794973442],[30.509100230362627,59.82502657222631],[30.514593394425145,59.82675515127727],[30.521974833634072,59.83073054156314],[30.527038844254196,59.83289088008955],[30.53210285487432,59.83159469385771],[30.543432505753298,59.830212039401744],[30.548494865726052,59.83313680304845],[30.55330138428073,59.835037770559964],[30.557421257327597,59.8326183384662],[30.55810790283541,59.828124639486376],[30.558794548343222,59.82570470343215],[30.56085448486668,59.82293884622331],[30.570467521976042,59.82034564582512],[30.579737236331507,59.8167148250228],[30.58729033691746,59.814466975112325],[30.589006950686972,59.811008447405925],[30.59123028299004,59.8102578682166]];
poly_vars.push(poly_var);
poly_var = [[30.438958595005744,60.042380247047056],[30.430718848912033,60.04598636945167],[30.41938919803308,60.04976378817867],[30.41286606570886,60.05113728747881],[30.404454658238432,60.05319742891588],[30.395528266636756,60.057317324812765],[30.389348457066355,60.06092181047491],[30.385915229527424,60.06812959682845],[30.382825324741876,60.07636513255381],[30.381108710972974,60.08142553196805],[30.379392097203,60.085284634877475],[30.376302192417658,60.08777137215788],[30.37338394900949,60.09068661755732],[30.367204139439416,60.09403025696719],[30.359307716099497,60.094716089646454],[30.349351356236397,60.09625916081416],[30.337678382603425,60.0964306086909],[30.33046860477132,60.09625916081416],[30.320512244908013,60.09625916081416],[30.31227249881448,60.09797359930514],[30.30780930301359,60.098316476308035],[30.306436011997995,60.101230785911696],[30.306436011997995,60.10363061138149],[30.30540604373642,60.10723002071274],[30.304719398228606,60.11031491462324],[30.307122657505783,60.11374223450909],[30.309869239537232,60.11665517502365],[30.316735694615343,60.118025881093224],[30.326692054478467,60.11973918316301],[30.337335059849813,60.11973918316301],[30.34763474246696,60.11922520193585],[30.358964393346138,60.11922520193585],[30.370980689732697,60.11922520193585],[30.382996986119256,60.11939652990643],[30.390206763951365,60.11973918316301],[30.398103187291337,60.117340535215476],[30.400849769322505,60.11391359110876],[30.41011948367797,60.1104862891174],[30.416985938755985,60.11031491462324],[30.42144913455677,60.10911526810766],[30.425912330357505,60.10380202077454],[30.432778785435517,60.0974592772007],[30.431405494419845,60.08631365249636],[30.43758530399035,60.07482112676837],[30.435868690220506,60.071561320792355],[30.43552536746684,60.0671000097986],[30.44548172733004,60.06263809339405],[30.45440811893159,60.06195159097778],[30.464021156040896,60.060921810484075],[30.48221726199776,60.0614367047614],[30.492173621861316,60.06298133922793],[30.49698014041597,60.05714567279427],[30.498696754185385,60.04907701702699],[30.49148697635348,60.04049116808733],[30.48565048953702,60.033620876028095],[30.478440711704913,60.03310554632185],[30.468141029087818,60.031215935055876],[30.46814169964014,60.02333553544502],[30.469514990655533,60.0222186287676],[30.48238959392713,60.02058615857378],[30.48685278972779,60.017492835283555],[30.505907202569663,60.01130531729144],[30.50642218670045,60.00606220528095],[30.518781805841286,59.99737915299481],[30.521871710626325,59.99419766045081],[30.51809516033327,59.992047829548845],[30.515863562433044,59.990671864220616],[30.512773657647752,59.98903783083141],[30.510713721124368,59.98645761328304],[30.508653784600885,59.98508141472742],[30.507280493585057,59.98422126147513],[30.505735541192667,59.983103028717395],[30.50178732952285,59.98336108579495],[30.49577918132931,59.98482337110672],[30.491315985528704,59.98662963406519],[30.487196112481787,59.988779818158825],[30.482732916680924,59.99178984042254],[30.47998633464988,59.99454162038962],[30.47775473674917,60.00460086149643],[30.476724768487642,60.00683583163047],[30.47483649334108,60.01104747881674],[30.469514990655533,60.01474297072605],[30.464880133477877,60.01689132201568],[30.46007361492279,60.01878175527747],[30.454237128106865,60.02264821273153],[30.449430609552337,60.02651421638413],[30.44479575237412,60.0321835342634],[30.442735815850764,60.03330010303337],[30.44239249309705,60.03604841869143],[30.441534186212213,60.03776599947712],[30.440332556573537,60.03922587268741],[30.43930258831201,60.04059981186085],[30.438958595005744,60.042380247047056]];
poly_vars.push(poly_var);
poly_var = [[30.096837470739114,59.99150904195056],[30.09649414798522,59.993916882480136],[30.09649414798522,59.99615257698917],[30.097524116246923,59.998388119924094],[30.098554084508653,60.002858751099474],[30.099584052770357,60.005609607429456],[30.10267395755552,60.00904785502643],[30.106450507848496,60.01231385803421],[30.111257026403177,60.01403267697872],[30.115033576696153,60.015407667581975],[30.122243354528184,60.01729818597406],[30.133916328161003,60.015407667581975],[30.14799256107115,60.01231385803421],[30.157948920934427,60.01145441494004],[30.17408509036803,60.00509383935388],[30.185414741246934,60.0042342079601],[30.186788032262555,59.9987320361535],[30.1895346142938,59.99219701432666],[30.185414741246934,59.988068964792205],[30.185414741246934,59.98411243247363],[30.1833548047235,59.98153182963541],[30.16000885745786,59.979639259261106],[30.133916328161003,59.98325225395583],[30.116750190465694,59.98531664472001],[30.099584052770357,59.98841298865428],[30.096837470739114,59.99150904195056]];
poly_vars.push(poly_var);
poly_var = [[30.50779480716454,59.98376836319964],[30.510541389195787,59.986348791100696],[30.514661262242758,59.98927303205312],[30.520497749059267,59.99202502201968],[30.52255768558227,59.99443282487757],[30.529767463414377,59.99804419954887],[30.539723823278138,60.00543768507577],[30.546590278356177,60.00784450860795],[30.562383125035762,60.011798194308845],[30.575429389684356,60.01403267642002],[30.59019226810244,60.011798194308845],[30.597745368688265,60.00956356067231],[30.604955146520247,60.0061253668761],[30.607358405797598,59.9927129836322],[30.612508247106273,59.984628528260785],[30.617314765660925,59.97774657976841],[30.62006134769217,59.96053542750272],[30.606671760289785,59.94951557994091],[30.598432014196074,59.943315299796694],[30.596028754918724,59.9376306874534],[30.591908881871777,59.930911248477976],[30.58469910403985,59.91884729065056],[30.58744568607112,59.91453766759698],[30.58744568607112,59.91057231847788],[30.59293885013356,59.8953961595049],[30.59122223636417,59.89022087828713],[30.59019226810244,59.87969531167069],[30.586072395055496,59.87106530328112],[30.577489326207868,59.84861676001142],[30.585042426793766,59.84170645761448],[30.59019226810224,59.83462190367607],[30.580922553746824,59.829609964382946],[30.56959290286787,59.8268444325227],[30.565816352574895,59.82770868597837],[30.564786384313166,59.83462190367607],[30.556889960973372,59.83721398911339],[30.5489935376334,59.83704118971659],[30.54006714603188,59.83634998312994],[30.533887336461373,59.83652278612628],[30.528050849644938,59.83859635189722],[30.51740784427395,59.84084256860141],[30.50916809817996,59.844989030731256],[30.502988288609785,59.84740756099357],[30.496808479039508,59.85034411069253],[30.49886841556302,59.85328040041718],[30.50401825687182,59.85466209386492],[30.50951142093398,59.85604372974585],[30.51603455325838,59.85794338508833],[30.521871040074814,59.86156969763012],[30.5277075268913,59.86450499347903],[30.53148407718379,59.865886219240934],[30.533887336461373,59.8688211328904],[30.53457398196911,59.87227363976529],[30.53354401370756,59.87538058843787],[30.53148407718379,59.87848724580012],[30.528394172398755,59.88349180330014],[30.528394172398755,59.88797800519758],[30.5277075268913,59.89211857531484],[30.5277075268913,59.895913643128765],[30.5277075268913,59.90022569218672],[30.5277075268913,59.90453717958806],[30.527364204137584,59.91384807639668],[30.528050849645396,59.91919203683352],[30.530797431676618,59.92281164857638],[30.534230659215673,59.925396843016195],[30.536290595739107,59.92884345457139],[30.537663886754757,59.93211740279256],[30.53972382327819,59.9357355999553],[30.541097114293812,59.939008865671255],[30.54281372806333,59.94176504853436],[30.54453034183287,59.94555442465609],[30.545903632848493,59.95020442871952],[30.549336860387548,59.95295967785856],[30.552083442418795,59.95674777019566],[30.553800056188336,59.9596746348955],[30.556203315465687,59.962601240200506],[30.556203315465687,59.96759308591623],[30.554830024450066,59.97086319629741],[30.54968018314147,59.97396089678662],[30.541097114293812,59.97688623585807],[30.529767463414913,59.979811315626215],[30.51740784427428,59.98256409502035],[30.51157135745787,59.98290817629587],[30.50779480716454,59.98376836319964]];
poly_vars.push(poly_var);




function initMap() { //30.328228,59.939784
    var spb = {lat: 59.939784, lng: 30.328228};

    map = new google.maps.Map(document.getElementById('map'), {
        center: spb,
        scrollwheel: true,
        zoom: 10
    });

    directionsDisplay = new google.maps.DirectionsRenderer({
        map: map,
        polylineOptions: {
            strokeColor: "#000099",
            strokeOpacity: 0.5
        }
    });
    directionsService = new google.maps.DirectionsService();


    poly_spb_kad = CratePoly(poly_spb_kad_var, map, '#00FF00');
    poly_vsevol = CratePoly(poly_vsevolozhsk_var, map, '#d60005');
    poly_VO = CratePoly(poly_VO_var, map, '#ffe708');
    poly_Petro = CratePoly(poly_Petro_var, map, '#d300d6');
    poly_Left = CratePoly(poly_Left_var, map, '#622c09');
    poly_Right = CratePoly(poly_Right_var, map, '#86ffe4');

    $.each( poly_vars, function( key, value ) {
        polys.push(CratePoly(value, map, '#000674'));
    });

    var order_id = $('#order_id').val();
    if (order_id > 0) {
        // не пересчитываем, для созданных заказов
        calc_route(0);
    }
}

function CratePoly(poly_arr,map, color){
    var points = ArrayToCoords(poly_arr);
    var poly = new google.maps.Polygon({
        paths: points,
        strokeColor: color,
        strokeOpacity: 0.05,
        strokeWeight: 2,
        fillColor: color,
        fillOpacity: 0.05
    });
    poly.setMap(map);
    return poly;
}

function ArrayToCoords(arr){
    var points = [];
    for (var i = 0; i < arr.length; i++) {
        points.push({
            lat: arr[i][1],
            lng: arr[i][0]
        });
    }
    return points;
}

function calc_route(recalc_cost, dest_point) {
	// Снимаем блокировку кнопки при перерасчете маршрута
    $('input.btn-submit').prop('disabled', false);
	
    // Удаляем старые маршруты
    $.each(order_route, function () {
        this.setMap(null);
    });

    // Адреса доставки
    var way_points = [];
    var i = 0;
    $('.spb-streets').each(function () {
        var coord = $(this).attr('coord');
        // Для старых заказов - без координат
        if (coord != '' && coord != 'null,null') {
            way_points.push({
                location: strToLatLngComma(coord),
                stopover: true
            });
            i++;
        }else{
            var route_address = $(this).val();
            var route_address_region = $(this).attr('region');
            var route_to_house = $(this).parent().parent().find('.to_house').val();
            if (route_address !== '') {
                route_address = (route_address.indexOf(',') > -1 || route_address_region == 47) ? 'Ленинградская обл., ' + route_address : 'Санкт-Петербург, ' + route_address;
                way_points.push({
                    location: (route_address + ((typeof route_to_house != 'undefined' && route_to_house != null && route_to_house != '') ? (', ' + route_to_house) : '')) + '',
                    stopover: true
                });
                i++;
            }
        }
    });

    if (i === 0) {
        alert_note('Необходимо ввести хотя бы один адрес доставки.');
        return false;
    }
    // Начальная точка маршрута
    var origin_point = (!$('#checkbox_hand_write').prop('checked'))?$("SELECT.store_address option:selected").text():'';
    // Конечная точка маршрута
    // Исклюаем конечную точку маршрута из промежуточных
    var destination_point = way_points.pop();
/*
    // Заглушка, на постоянный поиск адресов в яндексе.
    if (typeof dest_point == 'undefined'){
        getDestCoordsFromYandex(recalc_cost, destination_point.location);
        return true;
    }
*/
    var destination_point_location = (typeof dest_point == 'undefined' || dest_point == '') ? destination_point.location : dest_point;

    if (origin_point === '' || typeof origin_point === 'undefined'){
        origin_point = way_points.pop();
        origin_point = (typeof origin_point !== 'undefined') ? origin_point.location : '';
    }else{
        // origin_point = (origin_point.indexOf(',') > -1) ? 'Ленинградская обл., ' + origin_point : 'Ленинградская обл., Санкт-Петербург, ' + origin_point;
         origin_point = 'Санкт-Петербург, ' + origin_point;
    }
    if ( origin_point !== '' ) {
        directionsService.route({
            origin: origin_point,
            destination: destination_point_location,
            waypoints: way_points,
            region: 'ru',
            provideRouteAlternatives: true,
            optimizeWaypoints: true,
            avoidHighways: true,
            avoidTolls: true,
            // travelMode: google.maps.TravelMode.WALKING
            travelMode: google.maps.TravelMode.DRIVING
        }, function (response, status) {
            if (status === google.maps.DirectionsStatus.OK) {
                var routeIndex = getShortestRoute(response);
                directionsDisplay.setDirections(response);
                // Set route index
                directionsDisplay.setOptions({
                    routeIndex: routeIndex
                });
                var route = response.routes[routeIndex];
                var summaryPanel = document.getElementById('viewContainer');
                summaryPanel.innerHTML = '';
                var shortInfo = '';
                var delivery_sum = 0;
                // For each route, display summary information.
                for (var i = 0; i < route.legs.length; i++) {
                    var distanceInSPb = 0;
                    var distanceOutSideSPb = 0;
                    var neva_cross = false;
                    var end_in_geozone = false;
                    var end_in_vsevol = false;
                    var neva_path = [];
                    for (var k = 0; k < route.legs[i].steps.length; k++) {
                        var outside_path = [];
                        var inside_path = [];
                        var points_count = 0;
                        for (var z = 0; z < route.legs[i].steps[k].lat_lngs.length; z++) {
                            var way_latlangs = route.legs[i].steps[k].lat_lngs[z];
                            if (google.maps.geometry.poly.containsLocation(way_latlangs, poly_spb_kad)
                                || google.maps.geometry.poly.containsLocation(way_latlangs, poly_Right)) {
                                inside_path.push(way_latlangs);
                            } else {
                                outside_path.push(way_latlangs);
                            }
                            if (google.maps.geometry.poly.containsLocation(way_latlangs, poly_VO)) {
                                neva_path.push('VO');
                            }
                            if (google.maps.geometry.poly.containsLocation(way_latlangs, poly_Petro)) {
                                neva_path.push('Petro');
                            }
                            if (google.maps.geometry.poly.containsLocation(way_latlangs, poly_Left)) {
                                neva_path.push('Left');
                            }
                            if (google.maps.geometry.poly.containsLocation(way_latlangs, poly_Right)) {
                                neva_path.push('Right');
                            }
                            points_count = z;
                        }

                        if (outside_path.length > 0) {
                            var polyline_out = new google.maps.Polyline({
                                map: map, path: outside_path,
                                strokeColor: "#d60005", strokeOpacity: 0.8, strokeWeight: 3
                            });
                            distanceOutSideSPb += google.maps.geometry.spherical.computeLength(polyline_out.getPath());
                            // Записываем маршрут в массив для очистки
                            order_route.push(polyline_out);
                        }
                        if (inside_path.length > 0) {
                            var polyline_in = new google.maps.Polyline({
                                map: map, path: inside_path,
                                strokeColor: "#04d622", strokeOpacity: 0.8, strokeWeight: 2
                            });
                            distanceInSPb += google.maps.geometry.spherical.computeLength(polyline_in.getPath());
                            // Записываем маршрут в массив для очистки
                            order_route.push(polyline_in);
                        }
                    }
                    // Проверка попадания последней точки маршрута в геозону за КАДом
                    var end_way_latlang = route.legs[i].end_location;
                    $.each( polys, function( key, poly_out_kad ) {
                        if (google.maps.geometry.poly.containsLocation(end_way_latlang, poly_out_kad)) {
                            end_in_geozone = true;
                        }
                    });

                    // Проверка попадания последней точки маршрута в геозону за Всеволожск
                    if (google.maps.geometry.poly.containsLocation(end_way_latlang, poly_vsevol)) {
                        end_in_vsevol = true;
                    }

                    // iLog(neva_path.getUniqueGmap());
                    // iLog(neva_path.getUniqueGmap().length);
                    // Если мы сменили за путь несколько районов, то мы пересекали Неву
                    var uni = getUniqueGmap(neva_path);
                    if (uni.length > 1) {
                        neva_cross = true;
                    }
                    var moveList = '';
                    var cost_km = 0;
                    var cost_km_out = 0;
                    var cost_Neva = 0;
                    var cost_Geozone = 0; // Геозоны за пределами КАД по единому тарифу
                    var cost_Vsevol = 0; // Всеволожск по единому тарифу
                    var routeSegment = i + 1;

                    if (route.legs.length > 1) {
                        if (routeSegment > 1) {
                            summaryPanel.innerHTML += '<hr/>';
                            shortInfo += '<hr/>';
                            var beetween_point = Math.ceil(MetersToKilo(distanceInSPb) + MetersToKilo(distanceOutSideSPb));
                            if (beetween_point > 8){
                                alert_note('Расстояние между пунктами доставки не может превышать 8 км. Ваше расстояние ' +
                                    beetween_point + ' км. Вам необходимо создать отдельный заказ на данный маршрут.');
                                $('.btn-submit').attr('disabled','disabled');
                            }else{
                                $('.btn-submit').removeAttr('disabled');
                            }
                        }
                        summaryPanel.innerHTML += '<b>' + routeSegment + ': </b>';
                        shortInfo += '<b>' + routeSegment + ': </b>'
                    }

                    if (distanceInSPb > 0) {
                        cost_km = getRoutePrice(MetersToKilo(distanceInSPb));
                        moveList += ' город: ' + MetersToKilo(distanceInSPb) + ' км (' + cost_km + ' р)' + '<br/>';
                        shortInfo += '<b>' + MetersToKilo(distanceInSPb) + ' км</b><br/>'
                    }
                    if (neva_cross) {
                        cost_Neva = $('input#km_neva').val();
                        moveList += ' Нева: ' + cost_Neva + ' р<br/>';
                        // shortInfo += '<i>+ ' + cost_Neva + ' р</i><br/>'
                    }
                    if (end_in_geozone) {
                        cost_Geozone = $('input#km_geozone').val();
                        moveList += ' За КАД: ' + cost_Geozone + ' р<br/>';
                    }
                    if (end_in_vsevol) {
                        cost_Vsevol = $('input#km_vsevol').val();
                        moveList += ' За КАД: ' + cost_Vsevol + ' р<br/>';
                    }
                    if (distanceOutSideSPb > 0) {
                        // Если конечная точка попадает в Геозоны, то обнуляем стоимсоть за КАДом
                        cost_km_out = (!end_in_geozone && !end_in_vsevol)?getOutKADprice(MetersToKilo(distanceOutSideSPb)):0;
                        moveList += ' за городом: ' + MetersToKilo(distanceOutSideSPb) + ' км (' + cost_km_out + ' р) ' + '<br/>';
                        shortInfo += '<i>' + MetersToKilo(distanceOutSideSPb) + ' км</i><br/>'
                    }

                    if (recalc_cost > 0) {
                        // Если к определенному времени, то прибавляем стоимость точного времени.
                        var cost_target = $('.target').prop('checked') ? $('#km_target').val() : 0;
                        // Если установлена фиксированная стоимость по городу, то ставим ее вместо расчетной
                        var fixprice_inside = $('#user_fix_price').val();
                        var maxprice_inside = $('#user_max_price').val();
                        var cost_in_spb = (fixprice_inside == 0 || typeof fixprice_inside == 'undefined')
                            ? (parseFloat(cost_km) + parseFloat(cost_Neva))
                            : fixprice_inside;

                        if (parseFloat(cost_in_spb) > parseFloat(maxprice_inside) && parseFloat(maxprice_inside) != 0) {
                            cost_in_spb = maxprice_inside;
                        }

                        // Устанавливаем стоимость по маршруту и выполняем перерасчет
                        var cost_route = $('.cost_route').eq(i).get();



                        var result_cost = parseFloat(cost_in_spb)
                            + parseFloat(cost_km_out)
                            + parseFloat(cost_Geozone)
                            + parseFloat(cost_Vsevol)
                            + parseFloat(cost_target);

                        var add_money = getAddMoney($('.routes-block').eq(i).get(), result_cost);
                        moveList += ' за товар: ' + add_money + ' р ' + '<br/>';
                        result_cost = result_cost + add_money;

                        $(cost_route).val(result_cost);
                        re_calc(cost_route);

                        // summaryPanel.innerHTML += 'От: ' + route.legs[i].start_address + ',<br>';
                        // summaryPanel.innerHTML += 'До: ' + route.legs[i].end_address + '<br>';
                        summaryPanel.innerHTML += moveList + '<br>';

                        delivery_sum += result_cost;
                    }
                }
                $('#ShortInfo').html(shortInfo);
                if (delivery_sum > 0) {
                    $('.delivery_sum').html('<b>Итоговая сумма доставки заказа: ' + delivery_sum + '.00 руб</b>');
                    $('.delivery_sum_title').html('<b>' + delivery_sum + '.00 р.</b>');
                }
            } else {
                if (status == 'NOT_FOUND'){
                    var dest_point = response.request.destination;
                    getDestCoordsFromYandex(recalc_cost, dest_point);
                }else {
                    alert_note('Ошибка построения маршрута: ' + status);
                    catchMapError(origin_point,destination_point_location,way_points);
                }
            }
        });
    }
}

function catchMapError(origin_point,destination_point_location,way_points){
    var test = {};
    test['origin_point'] = origin_point;
    test['destination_point_location'] = destination_point_location;
    test['way_points'] = way_points;

    // Дополняем данными о пользователе
    var attrs = {};
    var $node = $('BODY').get(0);
    $.each( $node.attributes, function ( index, attribute ) {
        attrs[attribute.name] = attribute.value;
    });
    test['body'] = attrs;

    var json = JSON.stringify(test);
    $.post('/service/js_errors_catcher.php', {json: json});
}

function getAddMoney(obj, result_cost){
    var boxes = parseInt($(obj).find('input.goods_val').val());
    var cost_route = result_cost;
    var goods_id = $(obj).find('select.goods_type').val();
    var add_money = 0;
    if (goods_id > 0) {
        $('input[goods_id=' + goods_id + ']').each(function () {
            var price = parseInt($(this).attr('price'));
            var value = parseInt($(this).val());
            var mult = $(this).attr('mult');
            var fixed = $(this).attr('fixed');
            var cond = $(this).attr('condition');
            if (cond == '>' && boxes > value) {
                if (fixed == 1) {
                    add_money = add_money + price;
                } else {
                    add_money = add_money + (boxes - value) * price;
                }
                if (mult > 1) {
                    add_money = add_money + cost_route * (mult - 1);
                }
                // console.log('>')
            }
            if (cond == '<' && boxes < value) {
                console.log('<')
            }
            if (cond == '=' && boxes == value) {
                console.log('=')
            }
        });
    }
    return add_money;
}
function getDestCoordsFromYandex(recalc_cost, dest_point){
    $.get('https://geocode-maps.yandex.ru/1.x/?format=json&geocode='+dest_point, function(data){
        var dest_point = data.response.GeoObjectCollection.featureMember[0].GeoObject.Point.pos;
        if (typeof dest_point !== 'undefined'){
            var ll = strToLatLng(dest_point);
            calc_route(recalc_cost, ll);
        }else {
            console.log(data);
        }
    }).fail(function(data) {
        console.log(data.status);
        // 429 - Превышен лимит в 25 000 запросов в сутки
        if (data.status === 429) {
            calc_route(recalc_cost, '')
        }
    });
}
function strToLatLngComma(ll){
    var latlng = ll.split(',');
    return new google.maps.LatLng(parseFloat(latlng[0]), parseFloat(latlng[1]));
}

function strToLatLng(ll){
    var latlng = ll.split(' ');
    return new google.maps.LatLng(parseFloat(latlng[1]), parseFloat(latlng[0]));
}
/**
 * @return {number}
 */
function MetersToKilo(number){
    return Math.ceil(number / 100)/10;
}

function getRoutePrice(km_route){
    var cost_res = 0;
    $('input.km_cost').each(function(){
        var km_from = $(this).attr('km_from');
        var km_to = $(this).attr('km_to');
        var km_cost = $(this).val();
        if (km_route >= km_from && km_route < km_to ){
            cost_res = km_cost;
        }
    });
    return Math.ceil(cost_res);
}

function getOutKADprice(dist){
    var cost_km_kad = $('input#km_kad').val();
    return Math.ceil(dist*cost_km_kad);
}

function getUniqueGmap(obj){
    var u = {}, a = [];
    for(var i = 0, l = obj.length; i < l; ++i){
        if(u.hasOwnProperty(obj[i])) {
            continue;
        }
        a.push(obj[i]);
        u[obj[i]] = 1;
    }
    return a;
}

function getShortestRoute(response){
    var shortest = Number.MAX_VALUE;
    var routeIndex = 0;
    response.routes.forEach(function(rou, index) {
        if (rou.legs[0].distance.value < shortest) {
            shortest = rou.legs[0].distance.value  ;
            routeIndex = index;
        }
    });
    return routeIndex;
}
